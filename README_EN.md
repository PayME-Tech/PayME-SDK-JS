PayME SDK is a set of libraries for applications to interact with the PayME Platform. PayME SDK includes the following main functions:
- System of registration, login, eKYC via PayME wallet account
- Deposit, withdraw, transfer money from PayME wallet.
- Integration of PayME Platform services.

**Some terms**

|  | Name | Description |
|--|--|--|
| 1 | SDK | a toolkit to support the integration of PayME wallet into the application system. |
| 2 | backend | an integrated support system for the application, server or api |
| 3 | AES | Advanced Encryption Standard. [Reference](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard) |
| 4 | RSA| The Rivest-Shamir-Adleman (RSA) encryption algorithm. |
| 5 | IPN | Instant Payment Notification, used to communicate between the application's backend and the PayME's backend|

## Install
Place the following `<scripts>` tag near the bottom of your pages, just before the closing `</body>` tag, to activate the SDK.

**CDN via jsDelivr**
```javascript
<script src="https://cdn.jsdelivr.net/gh/PayME-Tech/WebSDKIntegration@8.2/payme-sdk.min.js"></script>
```
   
## Usage
The PayME system will provide the integrated application with the following information:

-   **PublicKey**  : Used to encrypt data, the built-in application needs to pass it to the SDK for encryption.
-   **AppToken**  : AppToken provides a unique identifier for each application, which needs to be passed to the SDK for encryption
-   **SecretKey**  : Use encrypted and authenticated data in the backend system for the integrated application.

The integrated application side will provide the PayME system with the following information:

-   **AppPublicKey**  : Will send through PayME's backend system for encryption.
-   **AppPrivateKey**: Will pass in PayME SDK to perform the decryption.

Encryption standard: RSA-512bit.

### Initialize the library
Before using PayME SDK, need to import SDK component and ref to use functions.

- When using another account, you need to update param configs

```javascript
const configs = {
   appToken,
   deviceId,
   publicKey,
   privateKey,
   env, 
   appId,
   partner,
   configColor
}
const payMe = new PaymeWebSdk({ id, configs })
```

#### Parameters
| Property | Type | Required | Description |
| -------------- | ---------- | -------- |  ------------------------------------------------------------ |
| `propStyle` | `object` | No | Custom styles for components |
| `appToken` | `string` | Yes | AppId provides a unique identifier for each app, which needs to be passed to the SDK for encryption. |
| `publicKey` | `string` | Yes | To encrypt data, the built-in application needs to pass it to the SDK for encryption. Due to the PayME system provided for the integrated application. |
| `privateKey` | `string` | Yes | app cần truyền vào để giải mã dữ liệu. Bên app sẽ cung cấp cho hệ thống PayME. |
| `deviceId` | `string` |Yes | the deviceId of the device |
| `env` | `string` | Yes | the environment using the SDK (sandbox, production) |
| `appId` | `string` | Yes | the appID when registering the merchant, generated by the PayME's system |
| `partner` | `object` | Yes | <pre lang="json">{<br>   paddingTop: Customize the position of the top corner when the device on the app has a custom header-statusbar<br>}</pre> |
| `configColor` | `string[]` | Yes | configColor : the color parameter to be able to change the color of PayME wallet transactions, the data type is string with the format #rrggbb. If 2 colors are transmitted, the PayME interface will gradient according to the 2 input colors. | 

[![img](https://github.com/PayME-Tech/PayME-SDK-Android-Example/raw/main/fe478f50-e3de-4c58-bd6d-9f77d46ce230.png?raw=true)](https://github.com/PayME-Tech/PayME-SDK-Android-Example/blob/main/fe478f50-e3de-4c58-bd6d-9f77d46ce230.png?raw=true)

### PayME SDK Error Code
| Constant | Error Code | Description 
| -------------- | ---------- | -------- |
| `EXPIRED` | `401` | Expired token |
| `ACCOUNT_LOCK` | `405` | Actively locked account |
| `NETWORK` | `-1` |  Network connection problem |
| `SYSTEM` | `-2` |  System error |
| `LIMIT` | `-3` |  The payment amount exceeds or is less than the transaction limit. |
| `NOT_ACTIVATED` | `-4` | Account not activated error |
| `KYC_NOT_APPROVED` | `-5` | Unapproved account error |
| `PAYMENT_ERROR` | `-6` | Payment failed |
| `ERROR_KEY_ENCODE` | `-7` | Data encryption/decryption error |
| `USER_CANCELLED` | `-8` | User cancels the action | 
| `NOT_LOGIN` | `-9` | Account not logged in | 
| `BALANCE_ERROR` | `-11` | Wallet balance is not enough | 
| `UNKNOWN_PAYCODE` | `-12` | Missing payCode information | 

### Functions of PayME SDK
#### login()
There are 2 cases

-  Used to login for the first time right after initializing PayME.
    
-  Used when the accessToken expires, when calling the SDK function that returns the error code ERROR_CODE.EXPIRED or ERROR_CODE.ACCOUNT_LOCK, the application needs to call login again to get the accessToken for other functions.
    
After calling login() successfully, then call other functions of the SDK (openWallet, pay, ...)

```javascript
const configsLogin = {
   ...configs,
   connectToken,
   phone,
   userId
}
payMe.login(
   configsLogin,
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```

#### Constant
| Property | Type | Description |
| ------------------ | ------ | ---------------------- |
| `ENV.SANDBOX` | `enum` | Sandbox environment. |
| `ENV.PRODUCTION` | `enum` | Production environment. |

| Property | Type | Description |
| ------------------ | ------ | ---------------------- |
| `NOT_ACTIVATED` | `enum` | Account not activated. |
| `NOT_KYC` | `enum` | Account not KYC. |
| `KYC_APPROVED` | `enum` | Account approved KYC. |
| `KYC_REVIEW` | `enum` | Account is pending approval |
| `KYC_REJECTED` | `enum` | Account is rejected |

#### Parameters
| Property | Type | Description |
| -------------- | ---------- | ------------------------------------------------------------ |
| `connectToken` | `string` | See how to create it below. |
| `phone` | `string` | Phone number of the system integrator |
| `userId` | `string`, `number` | A unique fixed value corresponding to each customer account in the service, usually this value is provided by the integrated system server for the PayME SDK |

How to create **connectToken**: 

connectToken is needed to pass to PayME and will be generated from the integrated app's backend. The structure is as follows:

```javascript
import forge from 'node-forge'

function encryptAES(text, secretKey) {
  // parse data into base64
  const iv = Buffer.from(ivbyte);
  const algorithm = determineAlthorithm(secretKey);
  const cipher = crypto.createCipheriv(algorithm, secretKey, iv);
  let encrypted = cipher.update(text, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return encrypted;
}

const data = {
  timestamp: "2021-01-20T06:53:07.621Z",
  userId : "abc",
  phone : "0123456789"
};

const connectToken = encryptAES(JSON.stringify(data), appSecretkey)
```

Create connectToken including KYC information (For partners with own KYC system)

```javascript
const data = {
  timestamp: "2021-01-20T06:53:07.621Z",
  userId : "abc",
  phone : "0123456789",
  kycInfo: {
    fullname: "Nguyễn Văn A",
    gender: "MALE",
    birthday: "1995-01-20T06:53:07.621Z",
    address: "15 Nguyễn cơ thạch",
    identifyType: "CMND",
    identifyNumber: "142744332",
    issuedAt: "2013-01-20T06:53:07.621Z",
    placeOfIssue: "Hồ Chí Minh",
    video: "https://file-examples-com.github.io/uploads/2017/04/file_example_MP4_480_1_5MG.mp4",
    face: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg",
    image: {
      front: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg",
      back: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg"
    }
  }
};

const connectToken = encryptAES(JSON.stringify(data), appSecretkey)
```

| **Constant** | **Required** | **Description** |
| :------------ | :----------- | :----------------------------------------------------------- |
| **timestamp** | Yes | ConnectToken creation time in the format iSO 8601. Used to determine the timeout time of connectToken. Example 2021-01-20T06:53:07.621Z |
| ***userId*** | Yes | a unique fixed value corresponding to each customer account in the service, usually this value is provided by the integrated system server for the PayME SDK |
| ***phone*** | Yes | Phone number of the system integrator |

Where ***AES*** is the encryption function according to the AES algorithm. Depending on the language on the server, the system side uses the corresponding library. See more here https://en.wikipedia.org/wiki/Advanced_Encryption_Standard

KycInfo parameters

**Parameters** | **Required** | **Explanation** |
| :----------- | :---------- | :------------------------------------------------- |
| fullname | Yes | Full name |
| gender | Yes | Gender ( MALE/FEMALE) |
| address | Yes | Address |
| identifyType | Yes | Type of document (ID/CCCD) |
| identifyNumber | Yes | Number of papers |
| issuedAt | Yes | Registration date |
| placeOfIssue | Yes | Place of issue |
| video | No | video link |
| face | No | path to face photo |
| front | No | link to a photo of the front of the document |
| back | No | link to photo of the back of the document

#### logout

⚠️⚠️⚠️ version 1.4.12 and later

Clear cache has the login account information. After logout, you need to do your login to perform your functions.

```javascript
payMe.logout(
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```

#### getAccountInfo

App can use this properties after you start SDK to know the bond status to PayME wallet.

```javascript
payMe.getAccountInfo(
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```
#### openWallet - Opens the PayME synthetic function UI

This function is called when from the built-in app when you want to call a PayME function by passing the Action parameter as above.

```javascript
payMe.openWallet(
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```

#### openHistory

This function is called when from the built-in app when wanting to open the transaction history from the wallet.

** Requires an activated account and identity to open Wallet history

⚠️⚠️⚠️ version 1.4.10 and later

```javascript
payMe.openHistory(
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```

#### scanQR
Open QR code scanning for payment

⚠️⚠️⚠️ version 1.4.10 and later

```javascript
payMe.scanQR(
   {
      payCode: String
   },
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```

**Parameters** | **Required** | **Explanation** |
| :----------------------------------------------------------- | :---------- | :------------------------------------------------- |
| payCode | Yes | [Payment Method List](#list-method-payment) |

QR format:

```javascript
const qrString = "{$type}|${storeId}|${action}|${amount}|${note}|${orderId}|${userName}"
```

- action: transaction type ('PAYMENT' => payment)
- amount: payment amount
- note: Description of transaction from counterparty side
- orderId: partner's transaction code, which needs to be unique on each transaction . Maximum 22 characters.
- storeId: ID of the paying public store that made the payment transaction
- userName: Account name
- type: OPENEWALLET

For example:

```javascript
const qrString = "OPENEWALLET|54938607|PAYMENT|20000|Chuyentien|2445562323|taikhoan"
```

#### payQRCode
The function used to pay the QR code provided by the partne

️⚠️⚠️ version 1.4.1 and later

```javascript
payMe.payQRCode(
   {
      qrContent: String,
      payCode: String,
      isShowResultUI: Boolean
   },
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```
**Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| qrContent | Yes| QR Code content. QR format like scanQR() |
| payCode | Yes | [Payment Method List](#list-method-payment) |
| isShowResultUI | No | Option to display the payment result UI. Default: true |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### deposit - Deposit money

```javascript
payMe.deposit(
   {
      amount: Number,
      closeWhenDone: Boolean
   },
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
);
```
**Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| amount | Yes| Used in case the action is Deposit/Withdraw, then enter the amount |
| closeWhenDone | No | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### withdraw - Withdraw money

```javascript
payMe.withdraw(
   {
      amount: Number,
      closeWhenDone: Boolean
   },
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
);
```
**Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| amount | Yes| Used in case the action is Deposit/Withdraw, then enter the amount |
| closeWhenDone | No | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### transfer - Transfer money

```javascript
payMe.transfer(
   {
      amount: Number,
      description: String
   },
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
);
```
**Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| amount | Yes| Used in case the action is Deposit/Withdraw/Transfer, then enter the amount |
| description | No| Content of money transfer |
| closeWhenDone | No | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### getListService

App can use this property after SDK initialization to get a list of services that PayME is providing

```javascript
payMe.getListService(
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
)
```
#### openService

This function is called when from the built-in app when you want to call a service that PayME also provides by passing the serviceCode parameter as follows

```javascript
payMe.openService(
serviceCode,
(response) => {
// onSuccess
} ,
(error) => {
// onError
}
)
```

| **Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| serviceCode | Yes| The service code from the service list is obtained from the function getListService |
| onSuccess | Yes | Used to catch callback when successfully executed from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### getListPaymentMethod - ⚠️⚠️⚠️ Removed from version 1.4.1 onwards
This function is called when from the built-in app when you want to get a list of payment methods that PayME provides vs each account after the account has been successful activation and identification, used to pass to the pay() function to directly select the payment method that the partner app wants

```javascript
payMe.getListPaymentMethod(
{
storeId
},
(response) => {
// onSuccess
},
(error) => {
// onError
}
)
```

| **Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| storeId | Yes| The ID of the payment gateway store that performed the payment transaction. |
| onSuccess | Yes | Used to catch callback when successfully executed from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### pay - Payment

This function is used when the app needs to pay an amount from the activated PayME wallet.
- When paying with PayME wallet, it is required that the account is activated, the identity and balance in the wallet must be greater than the payment amount
- Account information is obtained through the getAccountInfo() function
- Balance information is obtained through the getWalletInfo function ()

️⚠️⚠️ version 1.4.1 and later

```javascript
const  data = {
  amount:  Number,
  orderId:  String,
  storeId:  Number?,
  extractData: String,
  note:  String,
  userName: String?,
  payCode: String,
  isShowResultUI: Boolean?,
}
payMe.pay(
   data,
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
);
```
**Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :-------------------------------------------------  |
| amount | Yes | The amount to be paid by the app is passed to the SDK. |
| note | No | Description of the transaction from the counterparty. |
| orderId | Yes | Partner transaction code, which needs to be unique on each transaction. Up to 22 characters |
| storeId | No | The ID of the payment gateway store that performed the payment transaction. |
| userName | No | Account name. |
| isShowResultUI | No | Option to display the payment result UI. Default: true |
| payCode | Yes | [Payment Method List](#list-method-payment) |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK | #### getWalletInfo - Get ```javascript

#### getWalletInfo - Wallet information

```javascript
payMe.getWalletInfo(response => {
   (response) => {
      // onSuccess
   },
   (error) => {
      // onError
   }
})
```
```json
{
   "balance":  111,
   "cash":  1,
   "lockCash":  2
}
```
*balance*: The built-in app can use the value in the balance key to display, other fields are currently unused.

*detail.cash*: Money can be used.

*detail.lockCash*: Money is locked.

## List of payment methods
| **payCode** | **Payment Method** |
| :-----------| :------------|
| PAYME | PayME wallet payment |
| ATM | Domestic ATM card payment |
| MANUAL_BANK | Bank transfer payment |
| CREDIT | Credit card payments |
| VIET_QR | VietQR payments |

## License
Copyright 2020 @ [PayME](payme.vn)


